<html>
    <body>
        <div id="pagele-content">
            <div id="pagele-header">
                <h1>Pagele</h1>
            </div>
            
            <!-- Pagele Selection Modal -->
            <div id="pagele-modal" class="modal">
                <div class="modal-content">
                    <h2>Select a Pagele</h2>
                    <div id="pagele-list-container">
                        <div id="pagele-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <style>
        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #pagele-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pagele-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .pagele-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .pagele-cover {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .pagele-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .pagele-language {
            color: #666;
            font-size: 0.9em;
        }

        .pagele-difficulty {
            margin-top: 5px;
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .difficulty-easy {
            background-color: #d4edda;
            color: #155724;
        }

        .difficulty-medium {
            background-color: #fff3cd;
            color: #856404;
        }

        .difficulty-hard {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
    <script>


function createWebSocketConnection() {
    const socket = new WebSocket('wss://carriertech.uk:8675');
    //const socket = new WebSocket('ws://localhost:8675');
    socket.addEventListener('open', (event) => {
        console.log('WebSocket connection established');
    });

    socket.addEventListener('error', (error) => {
        console.error('WebSocket error:', error);
    });

    socket.addEventListener('message', (event) => {
            const response = JSON.parse(event.data);
            console.log("Received WebSocket message:", response);

            if (response.type === 'token_verification_result') {
                if (response.success) {
                    console.log('Token verification successful');
                    
                    // Check if user has a selected pagele
                    if (!response.user_data.selected_pagele) {
                        // Request available pageles
                        requestPageleList();
                    }
                } else {
                    console.log('Token verification failed');
                }
            } else if (response.type === 'pagele_list') {
                // Display the pagele selection modal with the list
                displayPageleList(response.pagele_books);
            } else if (response.type === 'pagele_selection_result') {
                if (response.success) {
                    console.log('Pagele selection successful');
                    hidePageleModal();
                    // Here you would load the selected pagele
                } else {
                    console.log('Pagele selection failed');
                }
            }
        });
    return socket;
}


function sendSocketMessage(message) {
    
    socket = createWebSocketConnection();
        
    socket.addEventListener('open', () => {
            socket.send(JSON.stringify(message));
        }, { once: true });
    
}

window.addEventListener('DOMContentLoaded', () => {
    
    // Check for stored token and username
    const storedToken = localStorage.getItem('token');
    const storedUsername = localStorage.getItem('username');
    console.log("storedToken: ", storedToken);
    console.log("storedUsername: ", storedUsername);
    
    if (storedToken) {
        sendSocketMessage({
            task: "verify_token",
            token: storedToken
        });
    }

});

// Function to request the list of available pageles
function requestPageleList() {
    sendSocketMessage({
        task: "get_pagele_list"
    });
}

// Function to display the pagele selection modal
function displayPageleList(pageleBooks) {
    const pageleList = document.getElementById('pagele-list');
    pageleList.innerHTML = '';
    
    if (pageleBooks.length === 0) {
        pageleList.innerHTML = '<p>No pagele books available.</p>';
    } else {
        pageleBooks.forEach(pagele => {
            const card = document.createElement('div');
            card.className = 'pagele-card';
            card.dataset.pageleId = pagele.filename;
            
            // Create difficulty class
            const difficultyClass = `difficulty-${pagele.difficulty.toLowerCase()}`;
            
            card.innerHTML = `
                <img class="pagele-cover" src="data:image/jpeg;base64,${pagele.cover}" alt="${pagele.book_name} cover">
                <div class="pagele-title">${pagele.book_name}</div>
                <div class="pagele-language">${pagele.language}</div>
                <div class="pagele-difficulty ${difficultyClass}">${pagele.difficulty}</div>
                <div class="pagele-sentences">${pagele.total_sentences} sentences</div>
            `;
            
            card.addEventListener('click', () => selectPagele(pagele.filename));
            pageleList.appendChild(card);
        });
    }
    
    showPageleModal();
}

// Function to show the pagele selection modal
function showPageleModal() {
    const modal = document.getElementById('pagele-modal');
    modal.style.display = 'block';
}

// Function to hide the pagele selection modal
function hidePageleModal() {
    const modal = document.getElementById('pagele-modal');
    modal.style.display = 'none';
}

// Function to select a pagele
function selectPagele(pageleFilename) {
    sendSocketMessage({
        task: "select_pagele",
        pagele_filename: pageleFilename,
        token: localStorage.getItem('token')
    });
}
    </script>
</html>