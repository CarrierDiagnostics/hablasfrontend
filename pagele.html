<html>
    <body>
        <div id="pagele-content">
            <div id="pagele-header">
                <h1>Pagele</h1>
            </div>
            
            <!-- Pagele Selection Modal -->
            <div id="pagele-modal" class="modal">
                <div class="modal-content">
                    <h2>Select a Pagele</h2>
                    <div id="pagele-list-container">
                        <div id="pagele-list"></div>
                    </div>
                </div>
            </div>
            
            <!-- Chapters Grid Modal -->
            <div id="chapters-modal" class="modal">
                <div class="modal-content">
                    <h2>Chapters</h2>
                    <div id="chapters-grid"></div>
                </div>
            </div>
            
            <!-- Sentence Display Modal -->
            <div id="sentence-modal" class="modal">
                <div class="modal-content">
                    <h2 id="chapter-title">Chapter Title</h2>
                    <div id="sentence-container">
                        <p id="current-sentence"></p>
                    </div>
                    <div id="sentence-controls">
                        <button id="prev-sentence">Previous</button>
                        <span id="sentence-counter">1/10</span>
                        <button id="next-sentence">Next</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <style>
        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #pagele-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pagele-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .pagele-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .pagele-cover {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .pagele-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .pagele-language {
            color: #666;
            font-size: 0.9em;
        }

        /* Chapters grid styling */
        #chapters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .chapter-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .chapter-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .chapter-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .chapter-points {
            font-size: 1.2em;
            color: #3a7bd5;
        }
        
        /* Sentence modal styling */
        #sentence-container {
            font-size: 1.2em;
            margin: 30px 0;
            min-height: 100px;
        }
        
        #sentence-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        #sentence-controls button {
            padding: 8px 16px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        #sentence-controls button:hover {
            background-color: #3367d6;
        }
        
        #sentence-controls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

    </style>
    <script>


function createWebSocketConnection() {
    //const socket = new WebSocket('wss://carriertech.uk:8675');
    const socket = new WebSocket('ws://localhost:8675');
    socket.addEventListener('open', (event) => {
        console.log('WebSocket connection established');
    });

    socket.addEventListener('error', (error) => {
        console.error('WebSocket error:', error);
    });

    socket.addEventListener('message', (event) => {
        const response = JSON.parse(event.data);
        console.log("Received WebSocket message:", response);

        // Handle array response (direct pagele list)
        if (Array.isArray(response)) {
            console.log('Received pagele list array directly');
            displayPageleList(response);
        }
        // Handle success response with user data
        else if (response.status === "success" && response.pagele == "{}") {
            
            if (!localStorage.getItem('username')) {
                localStorage.setItem('username', response.username);
            }
            
            requestPageleList();
            
        } 
        // Handle responses with type field (as in your original code)
        else if (response.type === 'token_verification_result') {
            if (response.success) {
                console.log('Token verification successful');
                
                // Check if user has a selected pagele
                if (!response.user_data.selected_pagele) {
                    // Request available pageles
                    requestPageleList();
                }
            } else {
                console.log('Token verification failed');
                // Handle invalid token
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                handleInvalidToken();
            }
        } else if (response.type === 'pagele_list') {
            // Display the pagele selection modal with the list
            displayPageleList(response.pagele_books);
        } else if (response.type === 'get_pagele') {
            const pagele_data = response.pagele_data;
            
            // Transform the chapter data format
            const chapters = [];
            
            // Convert the object-based chapter structure to an array
            Object.keys(pagele_data).forEach(key => {
                if (key.startsWith('chapter')) {
                    // Extract chapter number from key (e.g., "chapter1" -> 1)
                    const chapterNumber = parseInt(key.replace('chapter', ''));
                    
                    chapters.push({
                        title: `Chapter ${chapterNumber}`,
                        sentences: pagele_data[key],
                        points: 0 // Default points, update if available elsewhere
                    });
                }
            });
            
            // Sort chapters by number
            chapters.sort((a, b) => {
                const numA = parseInt(a.title.replace('Chapter ', ''));
                const numB = parseInt(b.title.replace('Chapter ', ''));
                return numA - numB;
            });
            
            displayChaptersGrid(chapters);
        } else if (response.status === "error") {
            // Handle error messages
            console.error('Server error:', response.message);
            if (response.message === "Invalid or expired token") {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                handleInvalidToken();
            }
        }
    });
    return socket;
}


function sendSocketMessage(message) {
    
    socket = createWebSocketConnection();
        
    socket.addEventListener('open', () => {
            socket.send(JSON.stringify(message));
        }, { once: true });
    
}

window.addEventListener('DOMContentLoaded', () => {
    
    // Check for stored token and username
    const storedToken = localStorage.getItem('token');
    const storedUsername = localStorage.getItem('username');
    console.log("storedToken: ", storedToken);
    console.log("storedUsername: ", storedUsername);
    
    if (storedToken) {
        sendSocketMessage({
            task: "verify_token",
            token: storedToken
        });
    }

});

// Function to request the list of available pageles
function requestPageleList() {
    sendSocketMessage({
        task: "get_pagele_list",
        token: localStorage.getItem('token')
    });
}

// Function to display the pagele selection modal
function displayPageleList(pageleBooks) {
    const pageleList = document.getElementById('pagele-list');
    pageleList.innerHTML = '';
    
    if (pageleBooks.length === 0) {
        pageleList.innerHTML = '<p>No pagele books available.</p>';
    } else {
        pageleBooks.forEach(pagele => {
            const card = document.createElement('div');
            card.className = 'pagele-card';
            card.dataset.pageleId = pagele.filename;
            
            card.innerHTML = `
                <img class="pagele-cover" src="${pagele.cover}" alt="${pagele.book_name} cover">
                <div class="pagele-title">${pagele.book_name}</div>
                <div class="pagele-language">${pagele.language}</div>
                <div class="pagele-sentences">${pagele.total_sentences} sentences</div>
            `;
            
            card.addEventListener('click', () => selectPagele(pagele.filename, pagele.language, 0));
            pageleList.appendChild(card);
        });
    }
    
    showPageleModal();
}

// Function to show the pagele selection modal
function showPageleModal() {
    const modal = document.getElementById('pagele-modal');
    modal.style.display = 'block';
}

// Function to hide the pagele selection modal
function hidePageleModal() {
    const modal = document.getElementById('pagele-modal');
    modal.style.display = 'none';
}

// Function to select a pagele
function selectPagele(pageleFilename, language, index) {
    sendSocketMessage({
        task: "init_pagele",
        pagele_filename: pageleFilename,
        language: language,
        index: index,
        token: localStorage.getItem('token')
    });
    console.log("Selected pagele:", pageleFilename);
    hidePageleModal();
}

// Function to display chapters in a grid
function displayChaptersGrid(chapters) {
    const chaptersGrid = document.getElementById('chapters-grid');
    chaptersGrid.innerHTML = '';
    
    if (!chapters || chapters.length === 0) {
        chaptersGrid.innerHTML = '<p>No chapters available.</p>';
    } else {
        chapters.forEach((chapter, index) => {
            const card = document.createElement('div');
            card.className = 'chapter-card';
            card.dataset.chapterIndex = index;
            
            card.innerHTML = `
                <div class="chapter-title">${chapter.title || `Chapter ${index + 1}`}</div>
                <div class="chapter-points">${chapter.points || 0} points</div>
            `;
            
            card.addEventListener('click', () => openSentenceModal(chapter, index));
            chaptersGrid.appendChild(card);
        });
    }
    
    showChaptersModal();
}

// Function to show the chapters modal
function showChaptersModal() {
    const modal = document.getElementById('chapters-modal');
    modal.style.display = 'block';
}

// Function to hide the chapters modal
function hideChaptersModal() {
    const modal = document.getElementById('chapters-modal');
    modal.style.display = 'none';
}

// Variables to track current sentence
let currentChapter = null;
let currentSentenceIndex = 0;
let sentences = [];

// Function to open the sentence modal for a chapter
function openSentenceModal(chapter, chapterIndex) {
    hideChaptersModal();
    
    currentChapter = chapter;
    currentSentenceIndex = 0;
    sentences = chapter.sentences || [];
    
    document.getElementById('chapter-title').textContent = chapter.title || `Chapter ${chapterIndex + 1}`;
    
    updateSentenceDisplay();
    
    const modal = document.getElementById('sentence-modal');
    modal.style.display = 'block';
    
    // Add event listeners for navigation buttons
    document.getElementById('prev-sentence').addEventListener('click', showPreviousSentence);
    document.getElementById('next-sentence').addEventListener('click', showNextSentence);
}

// Function to update the displayed sentence
function updateSentenceDisplay() {
    const sentenceElem = document.getElementById('current-sentence');
    const counterElem = document.getElementById('sentence-counter');
    const prevButton = document.getElementById('prev-sentence');
    const nextButton = document.getElementById('next-sentence');
    
    if (sentences.length === 0) {
        sentenceElem.textContent = "No sentences available for this chapter.";
        counterElem.textContent = "0/0";
        prevButton.disabled = true;
        nextButton.disabled = true;
        return;
    }
    
    sentenceElem.textContent = sentences[currentSentenceIndex];
    counterElem.textContent = `${currentSentenceIndex + 1}/${sentences.length}`;
    
    // Update button states
    prevButton.disabled = currentSentenceIndex === 0;
    nextButton.disabled = currentSentenceIndex === sentences.length - 1;
}

// Function to show the previous sentence
function showPreviousSentence() {
    if (currentSentenceIndex > 0) {
        currentSentenceIndex--;
        updateSentenceDisplay();
    }
}

// Function to show the next sentence
function showNextSentence() {
    if (currentSentenceIndex < sentences.length - 1) {
        currentSentenceIndex++;
        updateSentenceDisplay();
    }
}

// Function to close the sentence modal
function closeSentenceModal() {
    const modal = document.getElementById('sentence-modal');
    modal.style.display = 'none';
    showChaptersModal();
}

// Add click event to close modals when clicking outside
window.addEventListener('click', (event) => {
    const sentenceModal = document.getElementById('sentence-modal');
    const chaptersModal = document.getElementById('chapters-modal');
    const pageleModal = document.getElementById('pagele-modal');
    
    if (event.target === sentenceModal) {
        closeSentenceModal();
    } else if (event.target === chaptersModal) {
        hideChaptersModal();
    } else if (event.target === pageleModal) {
        hidePageleModal();
    }
});

    </script>
</html>